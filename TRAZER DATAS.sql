SELECT * FROM 
(SELECT 
	DISTINCT
	LEFT(ISNULL(SHABILITACAOALUNOCOMPL.IDMATRICSI,(CONCAT(SMP.RA,SMP.IDHABILITACAOFILIAL))),20) AS  MAT_CODMATRICULA,
	CONVERT(VARCHAR,SLOGPLETIVO.DTALTERACAO,103) AS MAT_DATAREALTERM,
	SSTATUS.DESCRICAO	AS MAT_SITUACAO
	
FROM SMATRICPL SMP(NOLOCK)

INNER JOIN SHABILITACAOALUNO ON
	SHABILITACAOALUNO.CODCOLIGADA = SMP.CODCOLIGADA 
AND SHABILITACAOALUNO.IDHABILITACAOFILIAL = SMP.IDHABILITACAOFILIAL 
AND SHABILITACAOALUNO.RA = SMP.RA

INNER JOIN SHABILITACAOALUNOCOMPL ON 
SHABILITACAOALUNOCOMPL.CODCOLIGADA = SHABILITACAOALUNO.CODCOLIGADA 
AND SHABILITACAOALUNOCOMPL.IDHABILITACAOFILIAL = SHABILITACAOALUNO.IDHABILITACAOFILIAL 
AND SHABILITACAOALUNOCOMPL.RA = SHABILITACAOALUNO.RA

LEFT JOIN SLOGPLETIVO ON 
SLOGPLETIVO.CODCOLIGADA = SMP.CODCOLIGADA 
AND SLOGPLETIVO.IDPERLET = SMP.IDPERLET 
AND SLOGPLETIVO.IDHABILITACAOFILIAL = SMP.IDHABILITACAOFILIAL 
AND SLOGPLETIVO.CODTURMA = SMP.CODTURMA 
AND SLOGPLETIVO.RA = SMP.RA 
AND SLOGPLETIVO.OPERACAO <> 'I'
AND SLOGPLETIVO.DTALTERACAO = (SELECT MAX( ULTIMAALTERACAO.DTALTERACAO)
										FROM 
											SLOGPLETIVO ULTIMAALTERACAO
                                         WHERE  
	                                         ULTIMAALTERACAO.CODCOLIGADA = SLOGPLETIVO.CODCOLIGADA
	                                         AND ULTIMAALTERACAO.CODFILIAL = SLOGPLETIVO.CODFILIAL 
	                                         AND ULTIMAALTERACAO.IDPERLET = SLOGPLETIVO.IDPERLET 
	                                         AND ULTIMAALTERACAO.IDHABILITACAOFILIAL = SLOGPLETIVO.IDHABILITACAOFILIAL 
	                                         AND ULTIMAALTERACAO.RA = SLOGPLETIVO.RA 
	                                         AND ULTIMAALTERACAO.CODTURMA = SLOGPLETIVO.CODTURMA 
	                                                                         
                                       )

INNER JOIN SSTATUS ON 
	SSTATUS.CODCOLIGADA = SMP.CODCOLIGADA 
AND SSTATUS.CODSTATUS = SMP.CODSTATUS
) TAB
WHERE TAB.MAT_CODMATRICULA  IN ('00387886168','00383875465','00382905465','00382165464','00381835465','00381805465','00381715464','00381685464','00381665464','00381655464','00381485464','00364055464','00383615465','00382795465','00382125464','00381825465','00381765465','00381705464','00381675464','00381515464','00364165464')


--SELECT TOP 1 * FROM SLOGPLETIVO WHERE CODCOLIGADA = 3