DECLARE @DATADE  DATETIME
DECLARE @DATAATE DATETIME

SET @DATADE = '2018-01-05'
SET @DATAATE = '2018-31-05'

SELECT 


DISTINCT
RIGHT(CONVERT(VARCHAR(10),@DATADE,103),7) AS 'Referencia',
GFILIAL.NOMEFANTASIA AS 'Unidade',
SMODALIDADECURSO.DESCRICAO AS 'Modalidade',
SAREA.NOME AS 'Área',
STURNO.NOME AS 'Turno',
SCURSO.NOME AS 'Curso',
--SGRADE.CARGAHORARIA,
SDISCIPLINA.CH,
ST.CODTURMA,
SDISCIPLINA.NOME,
CONVERT(VARCHAR(10),ST.DTINICIAL,103) AS 'DataInicial',
CONVERT(VARCHAR(10),ST.DTFINAL,103) AS 'DataFinal',
--CONVERT(VARCHAR(10),STD.DTINICIAL,103) AS 'DataInicial',
--CONVERT(VARCHAR(10),STD.DTFINAL,103) AS 'DataFinal',
(SELECT COUNT(SMATRICPL.RA) FROM STURMA

INNER JOIN SMATRICPL ON 
SMATRICPL.CODCOLIGADA  			= STURMA.CODCOLIGADA 	AND
SMATRICPL.CODFILIAL    			= STURMA.CODFILIAL 		AND
SMATRICPL.CODTURMA 				= STURMA.CODTURMA 		AND
SMATRICPL.IDPERLET 				= STURMA.IDPERLET 		AND
SMATRICPL.IDHABILITACAOFILIAL 	= STURMA.IDHABILITACAOFILIAL

WHERE SMATRICPL.CODTURMA = ST.CODTURMA


AND STURMA.CODCOLIGADA = ST.CODCOLIGADA
AND STURMA.CODFILIAL = ST.CODFILIAL
AND STURMA.IDPERLET = ST.IDPERLET
AND STURMA.IDHABILITACAOFILIAL = ST.IDHABILITACAOFILIAL
AND SMATRICPL.CODSTATUS != 1) AS 'Atendidos',

(SELECT COUNT(SMATRICPL.RA) FROM STURMA

INNER JOIN SMATRICPL ON 
SMATRICPL.CODCOLIGADA  			= STURMA.CODCOLIGADA 	AND
SMATRICPL.CODFILIAL    			= STURMA.CODFILIAL 		AND
SMATRICPL.CODTURMA 				= STURMA.CODTURMA 		AND
SMATRICPL.IDPERLET 				= STURMA.IDPERLET 		AND
SMATRICPL.IDHABILITACAOFILIAL 	= STURMA.IDHABILITACAOFILIAL

WHERE SMATRICPL.CODTURMA = ST.CODTURMA


AND STURMA.CODCOLIGADA = ST.CODCOLIGADA
AND STURMA.CODFILIAL = ST.CODFILIAL
AND STURMA.IDPERLET = ST.IDPERLET
AND STURMA.IDHABILITACAOFILIAL = ST.IDHABILITACAOFILIAL
AND SMATRICPL.CODSTATUS = 2) AS 'Matriculados'/*,

(SELECT CONVERT(INT,ISNULL(SUM(V_SI_CHDISCIPLINA.HRDISC),0))FROM V_SI_CHDISCIPLINA

	WHERE V_SI_CHDISCIPLINA.CODCOLIGADA = STD.CODCOLIGADA AND
		  V_SI_CHDISCIPLINA.CODFILIAL = STD.CODFILIAL AND
		  V_SI_CHDISCIPLINA.CODTURMA = STD.CODTURMA AND
		  V_SI_CHDISCIPLINA.IDPERLET = STD.IDPERLET AND
		  --V_SI_CHDISCIPLINA.IDTURMADISC = STD.IDTURMADISC AND
		  V_SI_CHDISCIPLINA.DATA >= @DATADE  AND V_SI_CHDISCIPLINA.DATA <= @DATAATE

) AS 'Horas Previstas'*/

FROM STURMA ST

INNER JOIN STURMACOMPL ON 
STURMACOMPL.CODCOLIGADA = ST.CODCOLIGADA AND
STURMACOMPL.CODFILIAL 	= ST.CODFILIAL   AND
STURMACOMPL.CODTURMA 	= ST.CODTURMA    AND
STURMACOMPL.IDPERLET 	= ST.IDPERLET
  
INNER JOIN SHABILITACAOFILIAL ON
SHABILITACAOFILIAL.CODCOLIGADA 			= ST.CODCOLIGADA 		AND
SHABILITACAOFILIAL.IDHABILITACAOFILIAL = ST.IDHABILITACAOFILIAL

INNER JOIN STURNO ON
STURNO.CODCOLIGADA = SHABILITACAOFILIAL.CODCOLIGADA AND
STURNO.CODTURNO = SHABILITACAOFILIAL.CODTURNO  

INNER JOIN SGRADE ON
SGRADE.CODCOLIGADA		= SHABILITACAOFILIAL.CODCOLIGADA 	AND
SGRADE.CODCURSO 		= SHABILITACAOFILIAL.CODCURSO 		AND
SGRADE.CODHABILITACAO 	= SHABILITACAOFILIAL.CODHABILITACAO AND
SGRADE.CODGRADE 		= SHABILITACAOFILIAL.CODGRADE
    
INNER JOIN SHABILITACAO ON
SHABILITACAO.CODCOLIGADA 	= SGRADE.CODCOLIGADA 	AND
SHABILITACAO.CODCURSO 		= SGRADE.CODCURSO 		AND
SHABILITACAO.CODHABILITACAO = SGRADE.CODHABILITACAO
   
INNER JOIN SCURSO ON
SCURSO.CODCOLIGADA 	= SHABILITACAO.CODCOLIGADA AND
SCURSO.CODCURSO 	= SHABILITACAO.CODCURSO

INNER JOIN SMODALIDADECURSO ON 
SMODALIDADECURSO.CODCOLIGADA = SCURSO.CODCOLIGADA AND
SMODALIDADECURSO.CODMODALIDADECURSO = SCURSO.CODMODALIDADECURSO

INNER JOIN SAREA ON 
SAREA.CODCOLIGADA = SCURSO.CODCOLIGADA AND
SAREA.CODAREA = SCURSO.CODAREA

INNER JOIN GFILIAL ON 
ST.CODCOLIGADA 	= GFILIAL.CODCOLIGADA AND
ST.CODFILIAL 	= GFILIAL.CODFILIAL

INNER JOIN STURMADISC STD ON 

STD.CODCOLIGADA = ST.CODCOLIGADA AND 
STD.CODFILIAL = ST.CODFILIAL AND 
STD.CODTURMA = ST.CODTURMA AND
STD.IDPERLET = ST.IDPERLET

INNER JOIN SDISCIPLINA ON 
	SDISCIPLINA.CODCOLIGADA = STD.CODCOLIGADA AND 
	SDISCIPLINA.CODDISC = STD.CODDISC

WHERE 

ST.CODCOLIGADA = 3
AND ST.DTFINAL >= @DATADE AND ST.DTINICIAL <= @DATAATE
AND STURMACOMPL.TIPOTURMA NOT IN ('11','12')
AND SCURSO.CODMODALIDADECURSO != 0000
AND SDISCIPLINA.CODDISC IN ('17.0213.040.01','17.0268.040.01','17.0421.008.01','17.0052.240.01','17.0053.220.01','17.0068.150.01','17.0289.310.01','17.0368.290.01','17.0407.100.01','17.0481.240.01','17.0506.130.01','17.0507.170.01','44.0011.160.01','17.0054.220.01','17.0069.150.01','17.0073.240.01','17.0244.240.01','17.0420.008.01','17.0510.130.01','17.0511.170.01','17.0013.080.01','17.0049.220.01','17.0050.240.01','17.0051.220.01','17.0066.150.01','17.0067.150.01','17.0074.240.01','17.0104.040.01','17.0130.160.01','17.0146.160.01','17.0170.040.01','17.0180.080.01','17.0203.100.01','17.0243.240.01','17.0257.192.01','17.0280.120.01','17.0358.020.01','17.0398.080.01','17.0410.300.01','17.0419.008.01','17.0423.070.01','17.0438.1000.01','17.0458.070.01','17.0480.240.01','17.0499.040.01','17.0501.040.01','17.0504.130.01','17.0505.170.01','17.0508.130.01','17.0509.170.01','44.0009.160.01','58.011.070.01','59.0007.180.01','59.0008.080.01','59.0009.320.01')