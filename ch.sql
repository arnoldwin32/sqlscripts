DECLARE @DATADE  DATETIME
DECLARE @DATAATE DATETIME

SET @DATADE = '2017-01-12'
SET @DATAATE = '2017-31-12'

SELECT
	3 AS TIPOREG,
	NULL AS OPERACAO,
	CARGAHORARIA.CH_CODMATRICULA,
	CARGAHORARIA.CH_MESANO,
	SUM(CARGAHORARIA.CH_FESCOLAR) CH_FESCOLAR,
	SUM(CARGAHORARIA.CH_FESTAGIO) CH_FESTAGIO,
	SUM(CARGAHORARIA.CH_PRAPROFISSIONAL) CH_PRAPROFISSIONAL
FROM
(
	SELECT 
		DISTINCT
		LEFT(ISNULL(SHABILITACAOALUNOCOMPL.IDMATRICSI,CONCAT(SMATRICPL.RA,SMATRICPL.IDHABILITACAOFILIAL)),20) AS  CH_CODMATRICULA,	
		CONVERT(VARCHAR,@DATADE,103) AS CH_MESANO,
		ISNULL(
			( 
				SELECT 
					CONVERT(INT, SUM(V_SI_CHDISCIPLINA.HRDISC) - ISNULL(SUM(V_SI_FALTA_ALU_DISCIPLINA.FALTA),0)) AS CHESCOLAR
				FROM 
					V_SI_CHDISCIPLINA
				 
				INNER JOIN SMATRICULA (NOLOCK) ON 
							V_SI_CHDISCIPLINA.CODCOLIGADA = SMATRICULA.CODCOLIGADA AND 
							V_SI_CHDISCIPLINA.IDTURMADISC = SMATRICULA.IDTURMADISC AND
							(V_SI_CHDISCIPLINA.CODSUBTURMA = SMATRICULA.CODSUBTURMA OR SMATRICULA.CODSUBTURMA IS NULL) 
							
				LEFT OUTER JOIN V_SI_FALTA_ALU_DISCIPLINA ON 
							V_SI_CHDISCIPLINA.CODCOLIGADA = V_SI_FALTA_ALU_DISCIPLINA.CODCOLIGADA AND 
							V_SI_CHDISCIPLINA.CODTURMA = V_SI_FALTA_ALU_DISCIPLINA.CODTURMA AND 
							V_SI_CHDISCIPLINA.IDPERLET = V_SI_FALTA_ALU_DISCIPLINA.IDPERLET AND 
							V_SI_CHDISCIPLINA.IDTURMADISC = V_SI_FALTA_ALU_DISCIPLINA.IDTURMADISC AND 
							V_SI_CHDISCIPLINA.DATA = V_SI_FALTA_ALU_DISCIPLINA.DATA  AND
							V_SI_FALTA_ALU_DISCIPLINA.RA = SMATRICULA.RA AND
							V_SI_FALTA_ALU_DISCIPLINA.DATA >= @DATADE AND V_SI_FALTA_ALU_DISCIPLINA.DATA <= @DATAATE
				WHERE 
					SMATRICULA.RA = SMATRICPL.RA AND
					V_SI_CHDISCIPLINA.CODCOLIGADA =  SMATRICPL.CODCOLIGADA   AND
					V_SI_CHDISCIPLINA.CODTURMA = SMATRICPL.CODTURMA AND	
					V_SI_CHDISCIPLINA.IDPERLET = SMATRICPL.IDPERLET AND
					V_SI_CHDISCIPLINA.NOME NOT LIKE '%ESTAGIO%' AND
					V_SI_CHDISCIPLINA.NOME NOT LIKE '%PRATICA PROFISSIONAL%' AND
					(
							(V_SI_CHDISCIPLINA.DATA <= SLOGPERIODO.DTALTERACAO AND SLOGPERIODO.CODSTATUS IN('5','7','9','17','46','48')  )
							OR 
							(SLOGPERIODO.CODSTATUS IN('10','11','13','15','20','43'))
							OR
							(SLOGPERIODO.DTALTERACAO IS NULL)
					)
					AND	
					V_SI_CHDISCIPLINA.DATA >= @DATADE  AND V_SI_CHDISCIPLINA.DATA <= @DATAATE 
				)
		
		,0)	AS CH_FESCOLAR,
		ISNULL(
		( 
		SELECT 
		  
		  CONVERT(INT, SUM(V_SI_CHDISCIPLINA.HRDISC) - ISNULL(SUM(V_SI_FALTA_ALU_DISCIPLINA.FALTA),0)) AS CHESCOLAR
		
		FROM V_SI_CHDISCIPLINA 
		 
		INNER JOIN SMATRICULA (NOLOCK) ON 
					V_SI_CHDISCIPLINA.CODCOLIGADA = SMATRICULA.CODCOLIGADA AND 
					V_SI_CHDISCIPLINA.IDTURMADISC = SMATRICULA.IDTURMADISC AND
					(V_SI_CHDISCIPLINA.CODSUBTURMA = SMATRICULA.CODSUBTURMA OR SMATRICULA.CODSUBTURMA IS NULL)
					
		LEFT OUTER JOIN V_SI_FALTA_ALU_DISCIPLINA ON 
					V_SI_CHDISCIPLINA.CODCOLIGADA = V_SI_FALTA_ALU_DISCIPLINA.CODCOLIGADA AND 
					V_SI_CHDISCIPLINA.CODTURMA = V_SI_FALTA_ALU_DISCIPLINA.CODTURMA AND 
					V_SI_CHDISCIPLINA.IDPERLET = V_SI_FALTA_ALU_DISCIPLINA.IDPERLET AND 
					V_SI_CHDISCIPLINA.IDTURMADISC = V_SI_FALTA_ALU_DISCIPLINA.IDTURMADISC AND 
					V_SI_CHDISCIPLINA.DATA = V_SI_FALTA_ALU_DISCIPLINA.DATA  AND
					V_SI_FALTA_ALU_DISCIPLINA.RA = SMATRICULA.RA AND
					V_SI_FALTA_ALU_DISCIPLINA.DATA >= @DATADE  AND V_SI_FALTA_ALU_DISCIPLINA.DATA <= @DATAATE
		WHERE 
			SMATRICULA.RA = SMATRICPL.RA AND
			V_SI_CHDISCIPLINA.CODCOLIGADA =  SMATRICPL.CODCOLIGADA   AND
			V_SI_CHDISCIPLINA.CODTURMA = SMATRICPL.CODTURMA AND	
			V_SI_CHDISCIPLINA.IDPERLET = SMATRICPL.IDPERLET AND
			V_SI_CHDISCIPLINA.NOME LIKE '%ESTAGIO%' AND
			(
					(V_SI_CHDISCIPLINA.DATA <= SLOGPERIODO.DTALTERACAO AND SLOGPERIODO.CODSTATUS IN('5','7','9','17','46','48')  )
					OR 
					(SLOGPERIODO.CODSTATUS IN('10','11','13','15','20','43'))
					OR
					(SLOGPERIODO.DTALTERACAO IS NULL)
			)
			AND	
			V_SI_CHDISCIPLINA.DATA >= @DATADE  AND V_SI_CHDISCIPLINA.DATA <= @DATAATE ),0)
		AS CH_FESTAGIO,
		ISNULL(
		( 
		SELECT 
		  
		  CONVERT(INT, SUM(V_SI_CHDISCIPLINA.HRDISC) - ISNULL(SUM(V_SI_FALTA_ALU_DISCIPLINA.FALTA),0)) AS CHESCOLAR
		
		FROM V_SI_CHDISCIPLINA 
		 
		INNER JOIN SMATRICULA (NOLOCK) ON 
					V_SI_CHDISCIPLINA.CODCOLIGADA = SMATRICULA.CODCOLIGADA AND 
					V_SI_CHDISCIPLINA.IDTURMADISC = SMATRICULA.IDTURMADISC AND
					(V_SI_CHDISCIPLINA.CODSUBTURMA = SMATRICULA.CODSUBTURMA OR SMATRICULA.CODSUBTURMA IS NULL)
					
		LEFT OUTER JOIN V_SI_FALTA_ALU_DISCIPLINA ON 
					V_SI_CHDISCIPLINA.CODCOLIGADA = V_SI_FALTA_ALU_DISCIPLINA.CODCOLIGADA AND 
					V_SI_CHDISCIPLINA.CODTURMA = V_SI_FALTA_ALU_DISCIPLINA.CODTURMA AND 
					V_SI_CHDISCIPLINA.IDPERLET = V_SI_FALTA_ALU_DISCIPLINA.IDPERLET AND 
					V_SI_CHDISCIPLINA.IDTURMADISC = V_SI_FALTA_ALU_DISCIPLINA.IDTURMADISC AND 
					V_SI_CHDISCIPLINA.DATA = V_SI_FALTA_ALU_DISCIPLINA.DATA  AND
					V_SI_FALTA_ALU_DISCIPLINA.RA = SMATRICULA.RA AND
					V_SI_FALTA_ALU_DISCIPLINA.DATA >= @DATADE  AND V_SI_FALTA_ALU_DISCIPLINA.DATA <= @DATAATE
		WHERE 
			SHABILITACAOALUNOCOMPL.CONDALUNO = '1' AND
			SMATRICULA.RA = SMATRICPL.RA AND
			V_SI_CHDISCIPLINA.CODCOLIGADA =  SMATRICPL.CODCOLIGADA   AND
			V_SI_CHDISCIPLINA.CODTURMA = SMATRICPL.CODTURMA AND	
			V_SI_CHDISCIPLINA.IDPERLET = SMATRICPL.IDPERLET AND
			V_SI_CHDISCIPLINA.NOME LIKE '%PRATICA PROFISSIONAL%' AND
			(
					(V_SI_CHDISCIPLINA.DATA <= SLOGPERIODO.DTALTERACAO AND SLOGPERIODO.CODSTATUS IN('5','7','9','17','46','48')  )
					OR 
					(SLOGPERIODO.CODSTATUS IN('10','11','13','15','20','43'))
					OR
					(SLOGPERIODO.DTALTERACAO IS NULL)
			)
			AND
			V_SI_CHDISCIPLINA.DATA >= @DATADE  AND V_SI_CHDISCIPLINA.DATA <= @DATAATE ),0)
		
		AS CH_PRAPROFISSIONAL
	
	FROM   
		STURMA (NOLOCK)
		
		JOIN STURMACOMPL (NOLOCK) 
			ON STURMACOMPL.CODCOLIGADA = STURMA.CODCOLIGADA 
			AND STURMACOMPL.CODFILIAL = STURMA.CODFILIAL 
			AND STURMACOMPL.CODTURMA = STURMA.CODTURMA 
			AND STURMACOMPL.IDPERLET = STURMA.IDPERLET
		
		JOIN SHABILITACAOFILIAL (NOLOCK) 
			ON SHABILITACAOFILIAL.CODCOLIGADA = STURMA.CODCOLIGADA 
			AND SHABILITACAOFILIAL.IDHABILITACAOFILIAL = STURMA.IDHABILITACAOFILIAL
		
		JOIN SCURSO (NOLOCK) 
			ON SCURSO.CODCOLIGADA = SHABILITACAOFILIAL.CODCOLIGADA 
			AND SCURSO.CODCURSO=SHABILITACAOFILIAL.CODCURSO
		
		JOIN SGRADE (NOLOCK) 
			ON SGRADE.CODCOLIGADA = SHABILITACAOFILIAL.CODCOLIGADA 
			AND SGRADE.CODCURSO = SHABILITACAOFILIAL.CODCURSO 
			AND SGRADE.CODHABILITACAO = SHABILITACAOFILIAL.CODHABILITACAO 
			AND SGRADE.CODGRADE = SHABILITACAOFILIAL.CODGRADE
		
		JOIN SHABILITACAO (NOLOCK) 
			ON SHABILITACAO.CODCOLIGADA = SCURSO.CODCOLIGADA 
			AND SHABILITACAO.CODCURSO = SCURSO.CODCURSO
		
		JOIN SGRADECOMPL (NOLOCK) 
			ON SGRADECOMPL.CODCOLIGADA = SGRADE.CODCOLIGADA 
			AND SGRADECOMPL.CODCURSO = SGRADE.CODCURSO 
			AND SGRADECOMPL.CODHABILITACAO = SGRADE.CODHABILITACAO 
			AND SGRADECOMPL.CODGRADE = SGRADE.CODGRADE
		
		JOIN SCURSOCOMPL(NOLOCK) 
			ON SCURSO.CODCOLIGADA = SCURSOCOMPL.CODCOLIGADA 
			AND SCURSO.CODCURSO = SCURSOCOMPL.CODCURSO
		
		JOIN SHABILITACAOALUNO (NOLOCK) 
			ON SHABILITACAOALUNO.CODCOLIGADA = SHABILITACAOFILIAL.CODCOLIGADA 
			AND SHABILITACAOALUNO.IDHABILITACAOFILIAL = SHABILITACAOFILIAL.IDHABILITACAOFILIAL
		
		JOIN SHABILITACAOALUNOCOMPL (NOLOCK)
			ON SHABILITACAOALUNOCOMPL.CODCOLIGADA = SHABILITACAOALUNO.CODCOLIGADA 
			AND SHABILITACAOALUNOCOMPL.IDHABILITACAOFILIAL = SHABILITACAOALUNO.IDHABILITACAOFILIAL 
			AND SHABILITACAOALUNOCOMPL.RA = SHABILITACAOALUNO.RA
		
		JOIN SMATRICPL (NOLOCK) 
			ON SMATRICPL.CODCOLIGADA = SHABILITACAOALUNO.CODCOLIGADA 
			AND SMATRICPL.IDHABILITACAOFILIAL = SHABILITACAOALUNO.IDHABILITACAOFILIAL 
			AND SMATRICPL.RA = SHABILITACAOALUNO.RA 
			AND SMATRICPL.CODTURMA = STURMA.CODTURMA
			AND SMATRICPL.IDPERLET = STURMA.IDPERLET
		
		JOIN SMATRICPLCOMPL (NOLOCK) 
			ON SMATRICPLCOMPL.CODCOLIGADA = SMATRICPL.CODCOLIGADA 
			AND SMATRICPLCOMPL.IDPERLET = SMATRICPL.IDPERLET 
			AND SMATRICPLCOMPL.IDHABILITACAOFILIAL = SMATRICPL.IDHABILITACAOFILIAL 
			AND SMATRICPLCOMPL.RA = SMATRICPL.RA
			
		JOIN SSTATUS (NOLOCK) 
			ON SSTATUS.CODCOLIGADA = SHABILITACAOALUNO.CODCOLIGADA 
			AND SSTATUS.CODSTATUS = SHABILITACAOALUNO.CODSTATUS	
			
		JOIN SCONTRATO (NOLOCK) 
			ON SCONTRATO.CODCOLIGADA = SMATRICPL.CODCOLIGADA 
			AND SCONTRATO.RA = SMATRICPL.RA 
			AND SCONTRATO.IDHABILITACAOFILIAL = SMATRICPL.IDHABILITACAOFILIAL 
			AND SCONTRATO.IDPERLET = SMATRICPL.IDPERLET
		
		LEFT JOIN SLOGPLETIVO SLOGGERAL (NOLOCK)
			ON SLOGGERAL.CODCOLIGADA = SMATRICPL.CODCOLIGADA 
			AND SLOGGERAL.IDPERLET = SMATRICPL.IDPERLET 
			AND SLOGGERAL.IDHABILITACAOFILIAL = SMATRICPL.IDHABILITACAOFILIAL 
			AND SLOGGERAL.CODTURMA = SMATRICPL.CODTURMA 
			AND SLOGGERAL.RA = SMATRICPL.RA 
			AND SLOGGERAL.CODSTATUS = SMATRICPL.CODSTATUS
			AND SLOGGERAL.OPERACAO <> 'I'
			AND SLOGGERAL.DTALTERACAO = (SELECT 
												MAX( ULTIMAALTERACAO.DTALTERACAO)
											FROM 
												SLOGPLETIVO ULTIMAALTERACAO
	                                         WHERE  
		                                         ULTIMAALTERACAO.CODCOLIGADA = SLOGGERAL.CODCOLIGADA
		                                         AND ULTIMAALTERACAO.CODFILIAL = SLOGGERAL.CODFILIAL 
		                                         AND ULTIMAALTERACAO.IDPERLET = SLOGGERAL.IDPERLET 
		                                         AND ULTIMAALTERACAO.IDHABILITACAOFILIAL = SLOGGERAL.IDHABILITACAOFILIAL 
		                                         AND ULTIMAALTERACAO.RA = SLOGGERAL.RA 
		                                         AND ULTIMAALTERACAO.CODTURMA = SLOGGERAL.CODTURMA 
		                                         AND ULTIMAALTERACAO.CODSTATUS = SLOGGERAL.CODSTATUS 
		                                         AND ULTIMAALTERACAO.OPERACAO = SLOGGERAL.OPERACAO
	                                       )
    
	    LEFT JOIN SLOGPLETIVO SLOGPERIODO (NOLOCK)
			ON SLOGPERIODO.CODCOLIGADA = SMATRICPL.CODCOLIGADA 
			AND SLOGPERIODO.IDPERLET = SMATRICPL.IDPERLET 
			AND SLOGPERIODO.IDHABILITACAOFILIAL = SMATRICPL.IDHABILITACAOFILIAL 
			AND SLOGPERIODO.CODTURMA = SMATRICPL.CODTURMA 
			AND SLOGPERIODO.RA = SMATRICPL.RA 
			AND SLOGPERIODO.CODSTATUS = SMATRICPL.CODSTATUS
			AND SLOGPERIODO.OPERACAO <> 'I'
			AND SLOGPERIODO.DTALTERACAO = (SELECT 
												MAX( ULTIMAALTERACAO.DTALTERACAO)
											FROM 
												SLOGPLETIVO ULTIMAALTERACAO
	                                         WHERE  
		                                         ULTIMAALTERACAO.CODCOLIGADA = SLOGPERIODO.CODCOLIGADA
		                                         AND ULTIMAALTERACAO.CODFILIAL = SLOGPERIODO.CODFILIAL 
		                                         AND ULTIMAALTERACAO.IDPERLET = SLOGPERIODO.IDPERLET 
		                                         AND ULTIMAALTERACAO.IDHABILITACAOFILIAL = SLOGPERIODO.IDHABILITACAOFILIAL 
		                                         AND ULTIMAALTERACAO.RA = SLOGPERIODO.RA 
		                                         AND ULTIMAALTERACAO.CODTURMA = SLOGPERIODO.CODTURMA 
		                                         AND ULTIMAALTERACAO.CODSTATUS = SLOGPERIODO.CODSTATUS 
		                                         AND ULTIMAALTERACAO.OPERACAO = SLOGPERIODO.OPERACAO
		                                         AND SLOGPERIODO.DTALTERACAO BETWEEN @DATADE AND @DATAATE
	                                       )
		
	WHERE  
		SCURSO.CODCOLIGADA = 3  
		AND STURMA.DTFINAL >= @DATADE AND STURMA.DTINICIAL <= @DATAATE 
		AND ((CONVERT(DATE,SMATRICPL.DTMATRICULA) < @DATADE) OR (CONVERT(DATE,SMATRICPL.DTMATRICULA) >= @DATADE AND CONVERT(DATE,SMATRICPL.DTMATRICULA) <= @DATAATE))
		--AND (SMATRICPLCOMPL.ENVIAPROD IS NULL OR SMATRICPLCOMPL.ENVIAPROD != 2)
		AND SMATRICPL.CODSTATUS != 1
	   
) AS CARGAHORARIA
WHERE CARGAHORARIA.CH_CODMATRICULA  IN ('2510251','00008085767','00016295792','00158005777','00158825086','00159025086','00159605113','00159645082','00161155753','00209015763','00209625819','00222295795','00223035795','00223125795','00223455795','00223625795','00223685795','00223865795','00223945795','00224455795','00224535795','00224685795','00224855795','00225135795','00225255795','00225345795','00225595795','00225685795','00225785795','00226295795','00226495795','00226545795','00226655795','00226685795','00226835795','00226945795','00227075795','00227315795','00227415795','00227505795','00227585795','00227635795','00227735795','00227845795','00227955795','00227975795','00228485795','00246515761','00262035785','00264355819','00265815706','00266035819','00267735819','00285595813','00285775813','00285885813','00285955813','00286145813','00286195813','00286235813','00286315813','00286355813','00286395813','00286485813','00286555813','00286605813','00286625813','00286655813','00286745813','00286775813','00286925813','00286985813','00287065813','00287085813','00287115813','00287175813','00287235813','00287315813','00287325813','00287355813','00287465813','00291655723','00292125763','00293305785','00293335819','00293395706','00293395819','00307395767','00309785767','00314895763','00333325530','00333955795','00334085795','00335495795','00335715723','00335835710','00335915813','00335965723','00336165761','00336435710','00336445753','00336645761','00336895723','00336895761','00336935710','00338625761','00338795710','00338875723','00344775723','00345455795','00345485795','00354175723','00356225530','00356525723','00356565723','00356565761','00356895723','00361905767','00364645761','00367625723','00371045819','00375935761','00376085761','00380015777','ID222863','ID222968','ID223072','ID223119','ID223281','ID223328','ID223354','ID223526','ID224665','ID224776','ID224836','ID224919','ID225009','ID225122','ID225280','ID225356','ID225946','ID226196','ID226276','ID226460','ID226502','ID239244','ID249620','ID263371','ID263413','ID263471','ID263592','ID263651','ID263761','ID263813','ID263864','ID264181','ID264273','ID264342','ID265412','ID265471','ID265502','ID265533','ID265665','ID265719','ID276571','ID420019','ID420264','ID420860','ID421562','ID422047','ID422265','ID430715','ID468928','ID470537','ID483255','ID489989','ID490946','ID491220')
GROUP BY CARGAHORARIA.CH_CODMATRICULA, CARGAHORARIA.CH_MESANO